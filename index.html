<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>메트로놈</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        :root {
    --led-green: #45a049;
    --led-red: #ff4444;
    --bg-dark: #1a1a1a;
    --bg-darker: #141414;
    --button-color: #2c2c2c;
    --button-hover: #3c3c3c;
    height: 100dvh;
}

body {
    margin: 0;
    height: 100%;
    background-color: var(--bg-dark);
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.metronome-grid {
    display: grid;
    grid-template-columns: repeat(16, 1fr);
    grid-template-rows: auto auto auto;
    gap: 1px;
    width: 90%;
    margin-bottom: 2rem;
    justify-items: center;
}

.beat-column {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    width: 80%;
    height: 70px;
    border: 1px solid #444;
    border-radius: 3px;
    background-color: #222;
    padding: 6px 2px;
    justify-content: space-between;
    min-width: 0;
    max-width: none;
}

.red-led {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: var(--bg-dark);
    border: 1px solid var(--led-red);
    min-width: 0;
}

.red-led.active {
    background-color: var(--led-red);
    box-shadow: 0 0 6px var(--led-red);
}

.green-led {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: var(--bg-dark);
    border: 1px solid var(--led-green);
    min-width: 0;
}

.green-led.active {
    background-color: var(--led-green);
    box-shadow: 0 0 6px var(--led-green);
}

.empty-space {
    width: 8px;
    height: 8px;
}

.empty-green {
    width: 12px;
    height: 12px;
}

.bpm-controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    width: 90%;
    margin-bottom: 2rem;
}

.bpm-display {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    justify-content: center;
    width: 100%;
}

.bpm-value {
    color: white;
    font-size: 1.8rem;
    width: 70px;
    background: transparent;
    border: none;
    text-align: center;
    padding: 0;
}

.bpm-label {
    color: white;
    font-size: 1.8rem;
}

.bpm-adjust {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    width: 100%;
}

.bpm-button {
    width: 35px;
    height: 35px;
    border-radius: 17px;
    border: none;
    background-color: var(--button-color);
    color: white;
    font-size: 1.3rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.bpm-button:hover {
    background-color: var(--button-hover);
}

.bpm-slider {
    width: 100%;
    margin: 0 1rem;
    -webkit-appearance: none;
    background: transparent;
}

.bpm-slider::-webkit-slider-runnable-track {
    width: 100%;
    height: 4px;
    background: #333;
    border-radius: 2px;
}

.bpm-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    height: 18px;
    width: 18px;
    border-radius: 50%;
    background: var(--button-color);
    margin-top: -7px;
    cursor: pointer;
    border: 1px solid #444;
}

.toggle-button {
    padding: 0.8rem 2.5rem;
    font-size: 1.1rem;
    border: none;
    border-radius: 20px;
    background-color: var(--button-color);
    color: white;
    cursor: pointer;
    min-width: 120px;
    transition: background-color 0.2s;
}

.toggle-button:hover {
    background-color: var(--button-hover);
}

.control-buttons {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.red-toggle {
    padding: 0.6rem 1.5rem;
    font-size: 0.9rem;
    border: none;
    border-radius: 15px;
    background-color: var(--led-red);
    color: white;
    cursor: pointer;
    transition: background-color 0.2s;
}

.red-toggle.disabled {
    background-color: #666;
}

.red-toggle:hover {
    opacity: 0.8;
}

.bpm-value::-webkit-inner-spin-button, 
.bpm-value::-webkit-outer-spin-button { 
    -webkit-appearance: none;
    margin: 0;
}

.bpm-value {
    -moz-appearance: textfield;
}

.yellow-led {
    width: 100%;
    height: 6px;
    background-color: #333;
    border-radius: 3px;
    border: 1px solid #666;
    min-width: 0;
}

.yellow-led.active {
    background-color: #ffd700;
    box-shadow: 0 0 6px #ffd700;
}
    </style>
</head>
<body>
    <div class="metronome-grid">
        <!-- 0번 칸: 빨간LED + 초록LED -->
        <div class="beat-column">
            <div class="red-led" id="red-0"></div>
            <div class="green-led" id="green-0"></div>
        </div>
        
        <!-- 1번 칸: 빈 칸 -->
        <div class="beat-column">
            <div class="empty-space"></div>
            <div class="empty-green"></div>
        </div>
        
        <!-- 2번 칸: 빈 칸 -->
        <div class="beat-column">
            <div class="empty-space"></div>
            <div class="empty-green"></div>
        </div>
        
        <!-- 3번 칸: 빨간LED -->
        <div class="beat-column">
            <div class="red-led" id="red-3"></div>
            <div class="empty-green"></div>
        </div>
        
        <!-- 4번 칸: 초록LED -->
        <div class="beat-column">
            <div class="empty-space"></div>
            <div class="green-led" id="green-4"></div>
        </div>
        
        <!-- 5번 칸: 빈 칸 -->
        <div class="beat-column">
            <div class="empty-space"></div>
            <div class="empty-green"></div>
        </div>
        
        <!-- 6번 칸: 빨간LED -->
        <div class="beat-column">
            <div class="red-led" id="red-6"></div>
            <div class="empty-green"></div>
        </div>
        
        <!-- 7번 칸: 빈 칸 -->
        <div class="beat-column">
            <div class="empty-space"></div>
            <div class="empty-green"></div>
        </div>
        
        <!-- 8번 칸: 초록LED -->
        <div class="beat-column">
            <div class="empty-space"></div>
            <div class="green-led" id="green-8"></div>
        </div>
        
        <!-- 9번 칸: 빨간LED -->
        <div class="beat-column">
            <div class="red-led" id="red-9"></div>
            <div class="empty-green"></div>
        </div>
        
        <!-- 10번 칸: 빈 칸 -->
        <div class="beat-column">
            <div class="empty-space"></div>
            <div class="empty-green"></div>
        </div>
        
        <!-- 11번 칸: 빈 칸 -->
        <div class="beat-column">
            <div class="empty-space"></div>
            <div class="empty-green"></div>
        </div>
        
        <!-- 12번 칸: 빨간LED + 초록LED -->
        <div class="beat-column">
            <div class="red-led" id="red-12"></div>
            <div class="green-led" id="green-12"></div>
        </div>
        
        <!-- 13번 칸: 빈 칸 -->
        <div class="beat-column">
            <div class="empty-space"></div>
            <div class="empty-green"></div>
        </div>
        
        <!-- 14번 칸: 빨간LED -->
        <div class="beat-column">
            <div class="red-led" id="red-14"></div>
            <div class="empty-green"></div>
        </div>
        
        <!-- 15번 칸: 빈 칸 -->
        <div class="beat-column">
            <div class="empty-space"></div>
            <div class="empty-green"></div>
        </div>
        <div class="yellow-led" id="yellow-0"></div>
        <div class="yellow-led" id="yellow-1"></div>
        <div class="yellow-led" id="yellow-2"></div>
        <div class="yellow-led" id="yellow-3"></div>
        <div class="yellow-led" id="yellow-4"></div>
        <div class="yellow-led" id="yellow-5"></div>
        <div class="yellow-led" id="yellow-6"></div>
        <div class="yellow-led" id="yellow-7"></div>
        <div class="yellow-led" id="yellow-8"></div>
        <div class="yellow-led" id="yellow-9"></div>
        <div class="yellow-led" id="yellow-10"></div>
        <div class="yellow-led" id="yellow-11"></div>
        <div class="yellow-led" id="yellow-12"></div>
        <div class="yellow-led" id="yellow-13"></div>
        <div class="yellow-led" id="yellow-14"></div>
        <div class="yellow-led" id="yellow-15"></div>
    </div>
    
    <div class="bpm-controls">
        <div class="bpm-display">
            <input type="number" class="bpm-value" value="60" min="30" max="200">
            <span class="bpm-label">BPM</span>
        </div>
        
        <div class="bpm-adjust">
            <button class="bpm-button">-</button>
            <input type="range" class="bpm-slider" min="30" max="200" value="60" step="1">
            <button class="bpm-button">+</button>
        </div>
    </div>
    
    <div class="control-buttons">
        <button class="red-toggle" id="red-toggle">빨간음 ON</button>
        <button class="toggle-button">시작</button>
    </div>

    <script>
        let isPlaying = false;
        let bpm = 60;
        let step = 0;
        let interval;
        let redSoundEnabled = true;

        // 16비트에서 빨간점이 켜질 위치 (0,3,6,9,12,14)
        const redBeatPositions = [0, 3, 6, 9, 12, 14]; 
        // 주박자 위치 (0,4,8,12)
        const mainBeatPositions = [0, 4, 8, 12];

        // Tone.js 신디사이저 설정
        const highSynth = new Tone.Synth({
            oscillator: {
                type: "triangle"
            },
            envelope: {
                attack: 0.001,
                decay: 0.03,
                sustain: 0,
                release: 0.01
            }
        }).toDestination();

        const lowSynth = new Tone.Synth({
            oscillator: {
                type: "triangle"
            },
            envelope: {
                attack: 0.001,
                decay: 0.03,
                sustain: 0,
                release: 0.01
            }
        }).toDestination();

        const redSynth = new Tone.Synth({
            oscillator: {
                type: "sine"
            },
            envelope: {
                attack: 0.001,
                decay: 0.02,
                sustain: 0,
                release: 0.01
            }
        }).toDestination();

        // DOM 요소 가져오기
        const toggleButton = document.querySelector('.toggle-button');
        const redToggleButton = document.getElementById('red-toggle');
        const bpmInput = document.querySelector('.bpm-value');
        const bpmSlider = document.querySelector('.bpm-slider');
        const bpmDecreaseBtn = document.querySelector('.bpm-button:first-child');
        const bpmIncreaseBtn = document.querySelector('.bpm-button:last-child');

        // BPM 업데이트 함수
        function updateBPM(newBPM) {
            bpm = Math.min(Math.max(newBPM, 30), 200);
            bpmInput.value = bpm;
            bpmSlider.value = bpm;
            if (isPlaying) {
                restartMetronome();
            }
        }

        // 빨간음 토글 함수
        function toggleRedSound() {
            redSoundEnabled = !redSoundEnabled;
            redToggleButton.textContent = redSoundEnabled ? "빨간음 ON" : "빨간음 OFF";
            redToggleButton.classList.toggle('disabled', !redSoundEnabled);
        }

        // LED 업데이트
        function updateLEDs(currentStep) {
            // 모든 LED 끄기
            document.querySelectorAll('.red-led, .green-led').forEach(led => {
                led.classList.remove('active');
            });

            // 현재 스텝에 해당하는 초록 LED 켜기
            if (mainBeatPositions.includes(currentStep)) {
                const greenLed = document.getElementById(`green-${currentStep}`);
                if (greenLed) {
                    greenLed.classList.add('active');
                }
            }

            // 빨간 LED 켜기
            if (redBeatPositions.includes(currentStep)) {
                const redLed = document.getElementById(`red-${currentStep}`);
                if (redLed) {
                    redLed.classList.add('active');
                }
            }

            document.querySelectorAll('.yellow-led').forEach(led => {
                led.classList.remove('active');
            });
            document.getElementById(`yellow-${currentStep}`).classList.add('active');
        }

        // 메트로놈 틱 함수
        function tick() {
            const isMainBeat = mainBeatPositions.includes(step);
            const isRedBeat = redBeatPositions.includes(step);
            
            // 첫 번째 박자는 높은 음
            const isHighTick = step === 0;
            
            // 주박자 소리
            if (isMainBeat) {
                const synth = isHighTick ? highSynth : lowSynth;
                const note = isHighTick ? "E6" : "A5";
                synth.triggerAttackRelease(note, "32n", undefined, 0.8);
            }
            
            // 빨간점 소리 (토글 설정에 따라)
            if (isRedBeat && redSoundEnabled) {
                redSynth.triggerAttackRelease("C6", "32n", undefined, 0.6);
            }
            
            updateLEDs(step);
            step = (step + 1) % 16;
        }

        // 메트로놈 시작/재시작
        function restartMetronome() {
            if (interval) clearInterval(interval);
            const intervalTime = (60 / bpm) * 1000 / 4; // 16분음표 간격
            interval = setInterval(tick, intervalTime);
        }

        // 메트로놈 토글
        function toggleMetronome() {
            isPlaying = !isPlaying;
            toggleButton.textContent = isPlaying ? "정지" : "시작";
            
            step = 0;
            if (isPlaying) {
                Tone.start();
                restartMetronome();
            } else {
                clearInterval(interval);
                document.querySelectorAll('.red-led, .green-led').forEach(led => {
                    led.classList.remove('active');
                });
            }
        }

        // 이벤트 리스너 설정
        toggleButton.addEventListener('click', toggleMetronome);
        redToggleButton.addEventListener('click', toggleRedSound);
        
        bpmInput.addEventListener('change', (e) => {
            updateBPM(parseInt(e.target.value));
        });

        bpmSlider.addEventListener('input', (e) => {
            updateBPM(parseInt(e.target.value));
        });

        bpmDecreaseBtn.addEventListener('click', () => {
            updateBPM(parseInt(bpm) - 1);
        });

        bpmIncreaseBtn.addEventListener('click', () => {
            updateBPM(parseInt(bpm) + 1);
        });
    </script>
</body>
</html>